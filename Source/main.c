/* 本例程uCOS-II 版本为2.51*/  
//#include <REG51.H>
#include <STC15F2K60S2.H>
#include "includes.h"
#include <stdlib.h>
#include <stdio.h>

//运行灯
sbit LED1 = P5^5;
sbit LED2 = P4^2;

sbit KEY1 = P2^2;
sbit KEY2 = P2^1;
sbit KEY3 = P2^0;
sbit KEY4 = P3^0;
sbit KEY5 = P3^1;
sbit KEY6 = P3^2;
sbit KEY7 = P3^3;
sbit KEY8 = P3^4;
sbit KEY9 = P3^5;

sbit LCD_RS  =  P3^5;      //寄存器选择输入 
sbit LCD_RW  =  P3^6;      //液晶读/写控制
sbit LCD_EN  =  P3^7;      //液晶使能控制
sbit LCD_PSB =  P4^6;      //串/并方式控制
sbit LCD_RST =  P4^7;      //液晶复位端口

typedef unsigned int uint;
typedef unsigned char uchar;
#define TRUE 1
#define FALSE 0
typedef enum {false , true } boolean;

//定义任务堆栈
OS_STK Task1Stk[MaxStkSize+1];		  //注意：在ASM文件中设置?STACK空间为40H即64
OS_STK Task2Stk[MaxStkSize+1];
OS_STK Task3Stk[MaxStkSize+1];


int i;

sbit rw=P3^6;    //1602 IO口定义  这里用的数据口是P0口
sbit rs=P3^5;
sbit ep=P3^7;
uchar bitmap[1024];//画布
uchar code number58[]={//5*8 0123456789数字
	0x31,0x0C,0x61,0x3C,0xCF,0x31,0x80,0x4B,0x12,0x93,0x21,0x29,0x4A,0x40,0x49,0x02,
	0x13,0x21,0x01,0x4A,0x40,0x49,0x04,0x65,0x39,0xC2,0x31,0xC0,0x49,0x08,0x15,0x05,
	0x24,0x48,0x40,0x49,0x10,0x97,0x85,0x24,0x4A,0x40,0x33,0x9E,0x61,0x38,0xC4,0x31,
	0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};
uchar code mask1[]={0x80,0x40,0x20,0x10,0x8,0x4,0x2,0x1};//10000000 01000000 ~ 00000001
uchar code mask2[]={0x7F,0xBF,0xDF,0xEF,0xF7,0xFB,0xFD,0xFE};//01111111 10111111 11011111
uchar code mask3[]={0,0x80,0xC0,0xE0,0xF0,0xF8,0xFC,0xFE};//10000000 11000000 ~ 11111110
uchar code mask4[]={0,0x1,0x3,0x7,0xF,0x1F,0x3F,0x7F};//00000001 00000011 ~ 01111111
uchar code number69[]={//6*9 0123456789+-*/.%=-
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x38,0x47,
	0x1C,0x09,0xE1,0x9F,0x38,0xE0,0x00,0x00,0x10,0x39,0x00,0x00,0x45,0xC0,0x82,0x19,
	0x02,0x01,0x45,0x11,0x00,0x44,0x20,0x2A,0x00,0x00,0x44,0x40,0x82,0x29,0x04,0x02,
	0x45,0x11,0x00,0x28,0x20,0x3C,0x78,0x00,0x44,0x41,0x0C,0x49,0xC7,0x82,0x38,0xF7,
	0xDF,0x10,0x40,0x0F,0x01,0xE0,0x44,0x42,0x02,0x48,0x24,0x44,0x44,0x11,0x00,0x28,
	0x40,0x15,0x78,0x00,0x44,0x44,0x02,0xFC,0x24,0x44,0x44,0x21,0x00,0x44,0x84,0x27,
	0x00,0x00,0x38,0x47,0x9C,0x09,0xC3,0x84,0x39,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};
uchar code author[]={
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x10,0x40,0x00,0x00,0x00,0x00,0x40,0x00,0x81,0x80,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x70,0xE0,0x07,0xFF,0x81,0x80,0x60,0x03,0xC3,0xC0,0x1F,0x9F,0xC0,0x07,
	0xE0,0x01,0xFD,0xFC,0x06,0x01,0x81,0xC0,0x60,0x3F,0xF7,0xF8,0x30,0x98,0x40,0x07,
	0xE0,0x0F,0xB3,0x6F,0x87,0xFF,0x80,0x70,0x60,0x3B,0x19,0x4C,0x1F,0x9F,0xC0,0x07,
	0xE0,0x0E,0x40,0x03,0x02,0x01,0x80,0x00,0x60,0x03,0xFF,0xC0,0x1F,0xCD,0xC0,0x07,
	0xE0,0x00,0x67,0xFC,0x03,0xFF,0x84,0xCF,0xFF,0xC3,0xFF,0xC0,0x00,0x66,0x00,0x07,
	0xE0,0x01,0x90,0x0C,0x03,0x73,0x0F,0xCE,0x6F,0x83,0x00,0xC0,0x1F,0xFF,0xE0,0x07,
	0xE0,0x01,0x98,0x4C,0x01,0xDE,0x00,0xC0,0x61,0x03,0xFF,0xC0,0x01,0x98,0x00,0x07,
	0xE0,0x00,0x9F,0xCC,0x1F,0x33,0xF0,0xC0,0x60,0x01,0xFF,0xC0,0x07,0x0F,0x80,0x07,
	0xE0,0x00,0x98,0x4C,0x3C,0xE7,0xF0,0xC0,0x60,0x10,0xFF,0x80,0xFC,0x01,0xF8,0x07,
	0xE0,0x01,0x9F,0xCC,0x0F,0x8C,0x70,0xC8,0x60,0x3F,0xFF,0xFE,0xFF,0xDF,0xF8,0x07,
	0xE0,0x01,0x98,0x4C,0x00,0x70,0xE0,0xF0,0x60,0x20,0x63,0x1C,0x18,0xD8,0x90,0x07,
	0xE0,0x03,0x9F,0xCC,0x07,0xC1,0xC1,0xF0,0x60,0x00,0xC3,0x00,0x18,0x98,0x80,0x07,
	0xE0,0x07,0x00,0x0C,0xFE,0x1F,0x81,0xC0,0x60,0x07,0x83,0x00,0x1F,0x9F,0x80,0x07,
	0xE0,0x06,0x00,0x0C,0x00,0x06,0x00,0x00,0x60,0x07,0x03,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE3,0xFE,0x22,0x89,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE2,0x02,0x22,0x45,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE2,0x22,0x47,0xE1,0x20,0x01,0xC2,0x1E,0x71,0xCF,0x9C,0x73,0xE2,0x1E,0x21,0xC7,
	0xE2,0xFA,0x94,0x81,0x7C,0x02,0x26,0x02,0x8A,0x28,0x22,0x8A,0x06,0x02,0x62,0x27,
	0xE2,0x22,0xEC,0x89,0x44,0x00,0x22,0x04,0x8A,0x28,0x22,0x8A,0x02,0x04,0x20,0x27,
	0xE3,0xFE,0x27,0xE5,0x7C,0x00,0xC2,0x04,0x12,0x2F,0x04,0x8B,0xC2,0x04,0x20,0xC7,
	0xE2,0x02,0x44,0x81,0x44,0x00,0x22,0x08,0x22,0x28,0x88,0x8A,0x22,0x08,0x20,0x27,
	0xE2,0xFA,0xF4,0x81,0x7C,0x00,0x22,0x08,0x42,0x20,0x90,0x88,0x22,0x08,0x20,0x27,
	0xE2,0x8A,0x07,0xE1,0x10,0x02,0x22,0x08,0x82,0x28,0xA0,0x8A,0x22,0x08,0x22,0x27,
	0xE2,0xFA,0x34,0x85,0x54,0x01,0xC7,0x08,0xF9,0xC7,0x3E,0x71,0xC7,0x08,0x71,0xC7,
	0xE4,0x02,0xC4,0x89,0x92,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE8,0x0E,0x07,0xE2,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x40,0x00,0x07,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xEF,0xFE,0x7F,0xC4,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE1,0x50,0x40,0x47,0xFC,0x01,0xC2,0x1E,0x71,0xCF,0x9C,0x73,0xE2,0x1C,0x70,0x47,
	0xE2,0x48,0x7F,0xC4,0x04,0x02,0x26,0x02,0x8A,0x28,0x22,0x8A,0x06,0x22,0x88,0xC7,
	0xEC,0x46,0x40,0x47,0xFC,0x00,0x22,0x04,0x8A,0x28,0x22,0x8A,0x02,0x22,0x88,0xC7,
	0xE3,0xF0,0x7F,0xC0,0x40,0x00,0xC2,0x04,0x12,0x2F,0x04,0x8B,0xC2,0x1C,0x89,0x47,
	0xE0,0x20,0x11,0x04,0x40,0x00,0x22,0x08,0x22,0x28,0x88,0x8A,0x22,0x22,0x8A,0x47,
	0xE0,0x40,0x91,0x27,0xFC,0x00,0x22,0x08,0x42,0x20,0x90,0x88,0x22,0x22,0x8B,0xE7,
	0xEF,0xFE,0x51,0x48,0x40,0x02,0x22,0x08,0x82,0x28,0xA0,0x8A,0x22,0x22,0x88,0x47,
	0xE0,0x40,0x31,0x83,0xF8,0x01,0xC7,0x08,0xF9,0xC7,0x3E,0x71,0xC7,0x1C,0x70,0xE7,
	0xE0,0x40,0x11,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE1,0xC0,0xFF,0xEF,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
};
uchar code help[]={
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x11,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x11,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x2F,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x21,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x6F,0xE0,0x00,0x3F,0xF8,0x7F,0xF0,0xFF,0xE1,0xFF,0xC3,0xFF,0x80,0x07,
	0xE0,0x00,0xA9,0x20,0x00,0x20,0x08,0x40,0x10,0x80,0x21,0x00,0x42,0x00,0x80,0x07,
	0xE0,0x00,0x2F,0xE0,0x00,0x23,0xC8,0x43,0x10,0x86,0x21,0x00,0x42,0x00,0x80,0x07,
	0xE0,0x00,0x29,0x00,0x00,0x22,0x48,0x44,0x90,0x89,0x21,0x08,0x42,0x10,0x80,0x07,
	0xE0,0x00,0x25,0x00,0x00,0x20,0x48,0x44,0x90,0x89,0x21,0x00,0x42,0x20,0x80,0x07,
	0xE0,0x00,0x22,0x00,0x00,0x20,0x88,0x43,0x10,0x87,0x21,0x3E,0x42,0x7E,0x80,0x07,
	0xE0,0x00,0x25,0x80,0x00,0x21,0x08,0x44,0x90,0x81,0x21,0x00,0x42,0x20,0x80,0x07,
	0xE0,0x00,0x28,0x60,0x00,0x21,0x08,0x44,0x90,0x89,0x21,0x08,0x42,0x10,0x80,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x21,0x08,0x43,0x10,0x86,0x21,0x00,0x42,0x00,0x80,0x07,
	0xE0,0x00,0x3F,0xE0,0x00,0x20,0x08,0x40,0x10,0x80,0x21,0x00,0x42,0x00,0x80,0x07,
	0xE0,0x00,0x22,0x20,0x00,0x3F,0xF8,0x7F,0xF0,0xFF,0xE1,0xFF,0xC3,0xFF,0x80,0x07,
	0xE0,0x00,0x22,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x3F,0xE0,0x00,0x3F,0xF8,0x7F,0xF0,0xFF,0xE1,0xFF,0xC3,0xFF,0x80,0x07,
	0xE0,0x00,0x22,0x20,0x00,0x20,0x08,0x40,0x10,0x80,0x21,0x00,0x42,0x00,0x80,0x07,
	0xE0,0x00,0x22,0x20,0x00,0x20,0x88,0x47,0x90,0x86,0x21,0x00,0x42,0x38,0x80,0x07,
	0xE0,0x00,0x3F,0xE0,0x00,0x21,0x88,0x44,0x10,0x89,0x21,0x22,0x42,0x44,0x80,0x07,
	0xE0,0x00,0x22,0x20,0x00,0x21,0x88,0x44,0x10,0x88,0x21,0x14,0x42,0x44,0x80,0x07,
	0xE0,0x00,0x22,0x20,0x00,0x22,0x88,0x47,0x10,0x8E,0x21,0x08,0x42,0x08,0x80,0x07,
	0xE0,0x00,0x22,0x20,0x00,0x22,0x88,0x40,0x90,0x89,0x21,0x14,0x42,0x10,0x80,0x07,
	0xE0,0x00,0x40,0xE0,0x00,0x23,0xC8,0x40,0x90,0x89,0x21,0x22,0x42,0x00,0x80,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x20,0x88,0x47,0x10,0x86,0x21,0x00,0x42,0x10,0x80,0x07,
	0xE0,0x00,0x24,0x20,0x00,0x20,0x08,0x40,0x10,0x80,0x21,0x00,0x42,0x00,0x80,0x07,
	0xE0,0x00,0x12,0x40,0x00,0x3F,0xF8,0x7F,0xF0,0xFF,0xE1,0xFF,0xC3,0xFF,0x80,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x07,0xE0,0x00,0x3F,0xF8,0x7F,0xF0,0xFF,0xE1,0xFF,0xC3,0xFF,0x80,0x07,
	0xE0,0x00,0x64,0x20,0x00,0x20,0x08,0x40,0x10,0x80,0x21,0x00,0x42,0x00,0x80,0x07,
	0xE0,0x00,0x24,0x20,0x00,0x21,0x08,0x43,0x10,0x86,0x21,0x00,0x42,0xE0,0x80,0x07,
	0xE0,0x00,0x24,0x20,0x00,0x23,0x08,0x44,0x90,0x89,0x21,0x00,0x42,0xA4,0x80,0x07,
	0xE0,0x00,0x27,0xE0,0x00,0x21,0x08,0x40,0x90,0x81,0x21,0x00,0x42,0xE8,0x80,0x07,
	0xE0,0x00,0x2A,0x40,0x00,0x21,0x08,0x41,0x10,0x86,0x21,0x3E,0x42,0x10,0x80,0x07,
	0xE0,0x00,0x32,0x40,0x00,0x21,0x08,0x42,0x10,0x81,0x21,0x00,0x42,0x2E,0x80,0x07,
	0xE0,0x00,0x24,0x50,0x00,0x21,0x08,0x44,0x10,0x89,0x21,0x00,0x42,0x4A,0x80,0x07,
	0xE0,0x00,0x08,0x30,0x00,0x23,0x88,0x47,0x90,0x86,0x21,0x00,0x42,0x0E,0x80,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x20,0x08,0x40,0x10,0x80,0x21,0x00,0x42,0x00,0x80,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x3F,0xF8,0x7F,0xF0,0xFF,0xE1,0xFF,0xC3,0xFF,0x80,0x07,
	0xE0,0x00,0x7D,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x45,0x10,0x00,0x3F,0xF8,0x7F,0xF0,0xFF,0xE1,0xFF,0xC3,0xFF,0x80,0x07,
	0xE0,0x00,0x45,0x10,0x00,0x20,0x08,0x40,0x10,0x80,0x21,0x00,0x42,0x00,0x80,0x07,
	0xE0,0x00,0x45,0xF0,0x00,0x20,0x08,0x43,0x10,0x80,0x21,0x00,0x42,0x00,0x80,0x07,
	0xE0,0x00,0x7D,0x10,0x00,0x24,0x68,0x44,0x90,0x80,0x21,0x08,0x42,0x00,0x80,0x07,
	0xE0,0x00,0x45,0x10,0x00,0x2A,0x88,0x44,0x90,0x80,0x21,0x08,0x42,0x00,0x80,0x07,
	0xE0,0x00,0x45,0xF0,0x00,0x2E,0x88,0x44,0x90,0x80,0x21,0x3E,0x42,0x3C,0x80,0x07,
	0xE0,0x00,0x45,0x10,0x00,0x2A,0x88,0x44,0x90,0x8C,0x21,0x08,0x42,0x00,0x80,0x07,
	0xE0,0x00,0x7D,0x10,0x00,0x2A,0x68,0x44,0x90,0x8C,0x21,0x08,0x42,0x3C,0x80,0x07,
	0xE0,0x00,0x41,0x10,0x00,0x20,0x08,0x43,0x10,0x80,0x21,0x00,0x42,0x00,0x80,0x07,
	0xE0,0x00,0x02,0x10,0x00,0x20,0x08,0x40,0x10,0x80,0x21,0x00,0x42,0x00,0x80,0x07,
	0xE0,0x00,0x04,0x70,0x00,0x3F,0xF8,0x7F,0xF0,0xFF,0xE1,0xFF,0xC3,0xFF,0x80,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
};
uchar value1[20];
uchar value2[20];
long double value;//左值 右值 结果
uchar status;
uchar operator;//操作符 对应symbol //6*9 0123456789+-*/.%=-
void cls_bitmap(){
	int i;
	for(i=0;i<1024;i++)bitmap[i]=0;
}
void delay_fast(unsigned int ii){
	while(ii-->0)_nop_();
}
void _nop_ (void);
#define delayNOP(); {_nop_();_nop_();_nop_();_nop_();};
bit lcd_busy(){
	bit result;
	LCD_RS = 0;
	LCD_RW = 1;
	LCD_EN = 1;
	delayNOP();
	result = (bit)(P0&0x80);
	LCD_EN = 0;
	return result; 
}
void lcd_wcmd(uchar cmd){
	while(lcd_busy());
	LCD_RS = 0;
	LCD_RW = 0;
	LCD_EN = 0;
	_nop_();
	_nop_(); 
	P0 = cmd;
	delayNOP();
	LCD_EN = 1;
	delayNOP();
	LCD_EN = 0;  
}
void lcd_wdat(uchar dat){
	while(lcd_busy());
	LCD_RS = 1;
	LCD_RW = 0;
	LCD_EN = 0;
	P0 = dat;
	delayNOP();
	LCD_EN = 1;
	delayNOP();
	LCD_EN = 0; 
}
void lcd_init(){
	LCD_PSB = 1;//并口方式
	LCD_RST = 0;//液晶复位
	LCD_RST = 1;
	lcd_wcmd(0x34);      //扩充指令操作
	delay_fast(15);
	lcd_wcmd(0x30);      //基本指令操作
	delay_fast(15);
	lcd_wcmd(0x0C);      //显示开，关光标
	delay_fast(15);
	lcd_wcmd(0x01);      //清除LCD的显示内容
}
void lcd_Clear() reentrant{//清屏
	lcd_wcmd(0x34);
	delay_fast(15);
	lcd_wcmd(0x30);
	delay_fast(15);
	lcd_wcmd(0x01);
	delay_fast(15);
}
void FullRender(uchar* bmp) reentrant{
  uchar i,j;
	int n=0;
	delay_fast(15);
  lcd_wcmd(0x34);
  for(i=0;i<32;i++){
    lcd_wcmd(0x80+i);
    lcd_wcmd(0x80);
    for(j=0;j<16;j++)lcd_wdat(bmp[n++]);
    delay_fast(15);
  }
  for(i=0;i<32;i++)
  { 
    lcd_wcmd(0x80+i);
    lcd_wcmd(0x88);
    for(j=0;j<16;j++)lcd_wdat(bmp[n++]);
		delay_fast(15);
  }
  lcd_wcmd(0x36);
}
//喂狗 硬件看门狗
void Feed_WDT(void) reentrant{
	WDT_CONTR = 0x3f; //EN_WDT=1,CLR_WDT=1,IDLE_WDT=0,PS2=0,PS1=0,PS0=0
	H_DOG = ~H_DOG;
}
boolean isDouble(uchar* ch){//是不是小数
	int i;
	for(i=0;i<20;i++)
		if(ch[i]=='.')return true;
	return false;
}
void init_caculator(){//初始化计算器 清空计算器
	uint i;
	for(i=0;i<20;i++)
		value1[i]=value2[i]=0;//左值 右值
	value=0;//结果
	operator=0;//操作符
	status=1;
	//0计算器没准备好
	//1计算器准备好了 请输入左值 此时也可以按符号
	//2请输入右值 此时可以按等于
	//3结果已出
}
void drawPixel(uchar x,uchar y,boolean result){
	if(result){
		bitmap[16*y+x/8]|=mask1[x%8];
	}else
		bitmap[16*y+x/8]&=mask2[x%8];
}
void drawOneSymbol(uchar symbol,uint x,uint y){//画一个符号 //6*9 0123456789+-*/.%=-
	int i,j,n,offset;
	for(j=0;j<9;j++)//列
		for(i=0;i<6;i++){//行
			n=(symbol*6+i)/8+j*14;//14=18*6/8+1 18代表一共18字符 18*6代表总宽度 /8代表字节 +1代表后面补0
			offset=(symbol*6+i)%8;
			if((number69[n]&mask1[offset])>>(7-offset))
				drawPixel(x+i,y+j,1);
			else
				drawPixel(x+i,y+j,0);
		}
}
void drawNumber(unsigned long number,uint x,uint y) reentrant{
	unsigned long n;
	int count=0;
	n=number;
	do{
		n/=10;
		count++;
	}while(n!=0);
	n=number;
	while(count-->0){
		drawOneSymbol(n%10,x+5*count,y);
		n/=10;
	}
}
void drawChar(uchar* ch,uint x,uint y){//画字符数组
	int i,pos=0;//6*9char
	for(i=0;i<20;i++)
		switch(ch[i]){
			case 0:
				return;//没有了
			case '0':
				drawOneSymbol(0,x+pos*6,y);
				pos++;
				break;
			case '1':
				drawOneSymbol(1,x+pos*6,y);
				pos++;
				break;
			case '2':
				drawOneSymbol(2,x+pos*6,y);
				pos++;
				break;
			case '3':
				drawOneSymbol(3,x+pos*6,y);
				pos++;
				break;
			case '4':
				drawOneSymbol(4,x+pos*6,y);
				pos++;
				break;
			case '5':
				drawOneSymbol(5,x+pos*6,y);
				pos++;
				break;
			case '6':
				drawOneSymbol(6,x+pos*6,y);
				pos++;
				break;
			case '7':
				drawOneSymbol(7,x+pos*6,y);
				pos++;
				break;
			case '8':
				drawOneSymbol(8,x+pos*6,y);
				pos++;
				break;
			case '9':
				drawOneSymbol(9,x+pos*6,y);
				pos++;
				break;
			case '-'://负号
				drawOneSymbol(17,x+pos*6,y);
				pos++;
				break;
			case '.'://小数点
				drawOneSymbol(14,x+pos*6,y);
				pos++;
				break;
		}
}
void Task1(void *ppdata) reentrant{
	ET0 = 1;       //根任务开时钟节拍中断 重要！！！！！！！！！！！！！！！！！！！！！！！！
	for(;;){
		OSTimeDly(OS_TICKS_PER_SEC);  //延时2s
		//LED2=~LED2;
	}
}

void Task2(void *ppdata) reentrant{
	for(;;){
		OSTimeDly(OS_TICKS_PER_SEC);
		Feed_WDT();
  }    
}
void doubleToStr(long double value,uchar* result){
	uchar tempBuffer[200];//防止缓冲区溢出
	for(i=0;i<200;i++)tempBuffer[i]=0;
	sprintf(tempBuffer,"%.15f",value);
	for(i=0;i<20;i++)result[i]=tempBuffer[i];
	for(i=19;i>=0;i--){
		if(result[i]==0)
			continue;
		else if(result[i]=='0')
			result[i]=0;
		else if(result[i]=='.'){
			result[i]=0;break;
		}else
			break;
	}
}
void render() reentrant{//渲染一页
	uchar result[20];
	cls_bitmap();
	lcd_Clear();
	LED1=~LED1;
	if(value1[0]==0)//说明没输入
		drawOneSymbol(0,10,10);
	else
		drawChar(&value1,10,10);
	if(operator!=0){
		drawOneSymbol(operator,10,23);//显示操作符
		if(value2[0]==0)//说明没输入
			drawOneSymbol(0,10,36);
		else
			drawChar(&value2,10,36);//显示右值
	}
	if(status==3){
		drawOneSymbol(16,10,50);//等于符号
		doubleToStr(value,result);
		if(result[0]==0)//说明没输入
			drawOneSymbol(0,20,50);
		else
			drawChar(&result,20,50);//显示右值
		
	}
	FullRender(&bitmap);
}
boolean inputNumber(uint status,char ch){
	uint i;
	if(status==1){
		if(ch=='0')if(value1[0]==0||(value1[0]=='-'&&value1[1]==0))return true;//没输入不允许按0
		if(ch=='.'&&(value1[0]=='-'&&value1[1]==0))value1[1]='0';
		if(ch=='.'&&value1[0]==0)value1[0]='0';//输入小数点 但没输入任何东西 前面要补0
		if(ch=='.'&&isDouble(value1))return true;//已经输入过小数点了
		for(i=0;i<20;i++){
			if(value1[i]==0){
				value1[i]=ch;
				return true;
			}
		}
	}else if(status==2){
		if(ch=='0')if(value1[0]==0||(value1[0]=='-'&&value1[1]==0))return true;//没输入不允许按0
		if(ch=='.'&&(value2[0]=='-'&&value2[1]==0))value2[1]='0';
		if(ch=='.'&&value2[0]==0)value2[0]='0';//输入小数点 但没输入任何东西 前面要补0
		if(ch=='.'&&isDouble(value2))return true;//已经输入过小数点了
		for(i=0;i<20;i++){
			if(value2[i]==0){
				value2[i]=ch;
				return true;
			}
		}
	}
	return false;
}
void DelNumber(uint status){
	uint i;
	if(status==1){
		for(i=1;i<20;i++)
			if(value1[i]==0){
				value1[i-1]=0;
				return;
			}
		value1[19]=0;
	}else if(status==2){
		for(i=1;i<20;i++)
			if(value2[i]==0){
				value2[i-1]=0;
				return;
			}
		value2[19]=0;
	}
}
void caculator(){//6*9 0123456789+-*/.%=-
	//uchar* ch1,uchar* ch2,uint operator
	switch(operator){
		case 10://加法
			value=atof(value1)+atof(value2);
			break;
		case 11://减法
			value=atof(value1)-atof(value2);
			break;
		case 12://乘
			value=atof(value1)*atof(value2);
			break;
		case 13://除
			value=atof(value1)/atof(value2);
			break;
		case 15://取余
			value=(int)atof(value1)%(int)atof(value2);
			break;
		case 16://等于
			value=atof(value1);
			break;
		default:
			value=-99;
	}
	status=3;
}
void scan() reentrant{
	long double result,result2;
	uchar operat;
	if(status==0)return;//计算器没准备好
	KEY6=0;
	KEY7=1;
	KEY8=1;
	KEY9=1;
	if(KEY1==0){//(1,5)//删除一个字符
		delay_fast(10);if(KEY1!=0)return;while(KEY1==0)OSTimeDly(1);//消除抖动 等待松开
		if(status==1||status==2)DelNumber(status);
		if(status==3)init_caculator();
		render();
	}
	if(KEY2==0){//(1,4)//除法
		delay_fast(10);if(KEY2!=0)return;while(KEY2==0)OSTimeDly(1);
		if(status==1){//按了之后准备按右值
			operator=13;status=2;
		}else if(status==2){//计算结果，并将结果放左值 并设置操作符
			if(value2[0]==0){
				operator=13;
			}else{
				caculator();//计算结果
				result=value;//结果：value
				init_caculator();
				operator=13;
				doubleToStr(result,value1);
				status=2;
			}
		}else if(status==3){//将计算结果放入左值
			result=value;//结果：value
			init_caculator();
			operator=13;
			doubleToStr(result,value1);
			status=2;
		}
		render();
	}
	if(KEY3==0){//(1,3)//9
		delay_fast(10);if(KEY3!=0)return;while(KEY3==0)OSTimeDly(1);
		if(status==3)init_caculator();
		if(status==1||status==2){//输入左值或右值
			inputNumber(status,'9');
		}
		render();
	}
	if(KEY4==0){//(1,2)//8
		delay_fast(10);if(KEY4!=0)return;while(KEY4==0)OSTimeDly(1);
		if(status==3)init_caculator();
		if(status==1||status==2){//输入左值或右值
			inputNumber(status,'8');
		}
		render();
	}
	if(KEY5==0){//(1,1)//7
		delay_fast(10);if(KEY5!=0)return;while(KEY5==0)OSTimeDly(1);
		if(status==3)init_caculator();
		if(status==1||status==2){//输入左值或右值
			inputNumber(status,'7');
		}
		render();
	}
	KEY6=1;
	KEY7=0;
	KEY8=1;
	KEY9=1;
	if(KEY1==0){//(2,5)//空
		FullRender(&help);
		delay_fast(10);if(KEY1!=0)return;while(KEY1==0)OSTimeDly(1);//消除抖动 等待松开
		if(status==3)init_caculator();
		render();
	}
	if(KEY2==0){//(2,4)//乘法
		delay_fast(10);if(KEY2!=0)return;while(KEY2==0)OSTimeDly(1);
		if(status==1){//按了之后准备按右值
			operator=12;status=2;
		}else if(status==2){//计算结果，并将结果放左值 并设置操作符
			if(value2[0]==0){
				operator=12;
			}else{
				caculator();//计算结果
				result=value;//结果：value
				init_caculator();
				operator=12;
				doubleToStr(result,value1);
				status=2;
			}
		}else if(status==3){//将计算结果放入左值
			result=value;//结果：value
			init_caculator();
			operator=12;
			doubleToStr(result,value1);
			status=2;
		}
		render();
	}
	if(KEY3==0){//(2,3)//6
		delay_fast(10);if(KEY3!=0)return;while(KEY3==0)OSTimeDly(1);
		if(status==3)init_caculator();
		if(status==1||status==2){//输入左值或右值
			inputNumber(status,'6');
		}
		render();
		
	}
	if(KEY4==0){//(2,2)//5
		delay_fast(10);if(KEY4!=0)return;while(KEY4==0)OSTimeDly(1);
		if(status==3)init_caculator();
		if(status==1||status==2){//输入左值或右值
			inputNumber(status,'5');
		}
		render();
	}
	if(KEY5==0){//(2,1)//4
		delay_fast(10);if(KEY5!=0)return;while(KEY5==0)OSTimeDly(1);
		if(status==3)init_caculator();
		if(status==1||status==2){//输入左值或右值
			inputNumber(status,'4');
		}
		render();
	}
	KEY6=1;
	KEY7=1;
	KEY8=0;
	KEY9=1;
	if(KEY1==0){//(3,5)//取余
		delay_fast(10);if(KEY1!=0)return;while(KEY1==0)OSTimeDly(1);//消除抖动 等待松开
		if(status==1){//按了之后准备按右值
			operator=15;status=2;
		}else if(status==2){//计算结果，并将结果放左值 并设置操作符
			if(value2[0]==0){
				operator=15;
			}else{
				caculator();//计算结果
				result=value;//结果：value
				init_caculator();
				operator=15;
				doubleToStr(result,value1);
				status=2;
			}
		}else if(status==3){//将计算结果放入左值
			result=value;//结果：value
			init_caculator();
			operator=15;
			doubleToStr(result,value1);
			status=2;
		}
		render();
	}
	if(KEY2==0){//(3,4)//减法或 负号
		delay_fast(10);if(KEY2!=0)return;while(KEY2==0)OSTimeDly(1);
		if(status==1){//按了之后准备按右值
			if(value1[0]=='-'&&value1[1]==0){//之前有负号那清除
				value1[0]=0;
			}else if(value1[0]==0){//没有左值
				value1[0]='-';//负号
			}else{
				operator=11;status=2;
			}
		}else if(status==2){//计算结果，并将结果放左值 并设置操作符
			if(value2[0]==0){
				operator=11;
			}else{
				caculator();//计算结果
				result=value;//结果：value
				init_caculator();
				operator=11;
				doubleToStr(result,value1);
				status=2;
			}
		}else if(status==3){//将计算结果放入左值
			result=value;//结果：value
			init_caculator();
			operator=11;
			doubleToStr(result,value1);
			status=2;
		}
		render();
	}
	if(KEY3==0){//(3,3)//3
		delay_fast(10);if(KEY3!=0)return;while(KEY3==0)OSTimeDly(1);
		if(status==3)init_caculator();
		if(status==1||status==2){//输入左值或右值
			inputNumber(status,'3');
		}
		render();
	}
	if(KEY4==0){//(3,2)//2
		delay_fast(10);if(KEY4!=0)return;while(KEY4==0)OSTimeDly(1);
		if(status==3)init_caculator();
		if(status==1||status==2){//输入左值或右值
			inputNumber(status,'2');
		}
		render();
		
	}
	if(KEY5==0){//(3,1)//1
		delay_fast(10);if(KEY5!=0)return;while(KEY5==0)OSTimeDly(1);
		if(status==3)init_caculator();
		if(status==1||status==2){//输入左值或右值
			inputNumber(status,'1');
		}
		render();
	}
	KEY6=1;
	KEY7=1;
	KEY8=1;
	KEY9=0;
	if(KEY1==0){//(4,5)//等于
		delay_fast(10);if(KEY1!=0)return;while(KEY1==0)OSTimeDly(1);//消除抖动 等待松开
		if(status==1){
			if(value1[0]==0)return;
			operator=16;
			caculator();
		}else if(status==2){//输入左值或右值
			if(value2[0]==0)return;//没输入右值不允许计算结果
			caculator();
		}else if(status==3){
			//结果已出
			result=value;//结果：value
			result2=atof(value2);
			operat=operator;
			init_caculator();
			operator=operat;
			doubleToStr(result,value1);//结果当左值
			doubleToStr(result2,value2);//右值
			caculator();
		}
		render();
	}
	if(KEY2==0){//(4,4)//加法
		delay_fast(10);if(KEY2!=0)return;while(KEY2==0)OSTimeDly(1);
		if(status==1){//按了之后准备按右值
			operator=10;status=2;
		}else if(status==2){//计算结果，并将结果放左值 并设置操作符
			if(value2[0]==0){
				operator=10;
			}else{
				caculator();//计算结果
				result=value;//结果：value
				init_caculator();
				operator=10;
				doubleToStr(result,value1);
				status=2;
			}
		}else if(status==3){//将计算结果放入左值
			result=value;//结果：value
			init_caculator();
			operator=10;
			doubleToStr(result,value1);
			status=2;
		}
		render();
	}
	if(KEY3==0){//(4,3)//小数点
		delay_fast(10);if(KEY3!=0)return;while(KEY3==0)OSTimeDly(1);
		if(status==3)init_caculator();
		if(status==1||status==2){//输入左值或右值
			inputNumber(status,'.');
		}
		render();
	}
	if(KEY4==0){//(4,2)//0
		delay_fast(10);if(KEY4!=0)return;while(KEY4==0)OSTimeDly(1);
		if(status==3)init_caculator();
		if(status==1||status==2){//输入左值或右值
			inputNumber(status,'0');
		}
		render();
	}
	if(KEY5==0){//(4,1)//清空所有
		delay_fast(10);if(KEY5!=0)return;while(KEY5==0)OSTimeDly(1);
		init_caculator();
		render();
	}
}

void Task3(void *ppdata) reentrant{
	//lcd_Clear();
	FullRender(&author);
	OSTimeDly(OS_TICKS_PER_SEC*2);
	FullRender(&help);
	OSTimeDly(OS_TICKS_PER_SEC*2);
	init_caculator();
	render();
	for(;;){
		scan();

		//LED1=~LED1;
		//LED2=~LED2;
		OSTimeDly(OS_TICKS_PER_SEC/10);
  }    
}

void main(void){
	OSInit();
	//定时器初始化
	TMOD &= 0xF0;TMOD |= 0x01;TR0 = 1;
	//芯片IO口初始化
	P0M0 = 0X00;P0M1 = 0X00;P1M0 = 0X00;P1M1 = 0X00;P2M0 = 0X00;P2M1 = 0X00;P3M0 = 0X00;P3M1 = 0X00;P4M0 = 0X00;P4M1 = 0X00;
	//LCD12864初始化
	lcd_init();
	//LCD12864清屏
	lcd_Clear();
	//狗饿了，喂狗
	Feed_WDT();
	//初始化画布
	cls_bitmap();
	OSTaskCreate(Task1,(void*)0,&Task1Stk[0],0);  //优先级
	OSTaskCreate(Task2,(void*)0,&Task2Stk[0],1);
	OSTaskCreate(Task3,(void*)0,&Task3Stk[0],2);
	OSStart();
}